<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="mobile-web-app-capable" content="yes">

    <title>cURLaaS</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.rawgit.com/twbs/bootstrap/v4-dev/dist/css/bootstrap.css">
    <link rel="stylesheet" href="/s/css/style.css">
    <link rel="icon" href="/s/favicon.ico">
  </head>

  <body>

    <div class="container">
      <div class="row">
        <div class="col-sm-offset-1 col-sm-9">

          <h3 class="title">
            cURLaaS 
          </h3>

          <div id="ui-json" class="ui">
          </div>

          <div class="footer">
            &copy;krkr
          </div>

        </div>
      </div>
    </div>

    <script id="tpl-json" type="text/ractive">
      <form>
        <fieldset class="form-group">
          <input type="text" id="searchTerm" class="form-control" value="{{searchTerm}}" placeHolder="Search">
        </fieldset>
      </form>

      {{#each filtered:i}}
      <div class="card">
        <div class="card-block">
          <h4 class="card-title">{{category}}</h4>
        </div>
        <ul class="list-group list-group-flush">
          {{#each curls}}
          <li class="list-group-item">
            <div class="input-group">
              <span class="input-group-btn">
                <button class="btn btn-primary-outline btn-curl-name" data-clipboard-target="#{{name}}">
                    {{name}}
                </button>
              </span>
              <input type="text" id="{{name}}" class="curl-snippet form-control" readonly value="{{curl}}" onclick="this.select();">
              <span class="input-group-btn">
                <a class="btn btn-success-outline" href="/s/see.html?c={{category}}&n={{name}}&curl={{curl}}" title="See {{category}}/{{name}} script">
                    ->
                </a>
              </span>
            </div>
          </li>
          {{/each}}
        </ul>
      </div>
      {{/each}}
    </script>

    <script src="http://cdn.ractivejs.org/latest/ractive.min.js"></script>
    <script src="https://cdn.rawgit.com/zenorocha/clipboard.js/master/dist/clipboard.min.js"></script>
    <script src="/s/js/script.js"></script>
    
    <script>
        function showTooltip(elem, msg) {
            elem.setAttribute('class', 'btn tooltipped tooltipped-s');
            elem.setAttribute('aria-label', msg);
        }
        
        var clipboard = new Clipboard('.btn');
        clipboard.on('success', function(e) {
            showTooltip(e.trigger, 'Copied!');
        });

        function fetch(path, el, tpl, cb) {
          microAjax(apiUrl + path, function(data) {
            
              var ractive = new Ractive({
                  el: el, template: tpl,
                  data: {
                    searchTerm: '',
                    data: JSON.parse(data),
                    filtered: []
                  },
                  complete: function(){
                    var r = this
                    r.observe('searchTerm', function(searchTerm){
                        var filtered = [];
                        var data = r.get('data');

                        for (var i = 0; i < data.length; i++) {
                          var group = data[i];
                        //r.get('data').filter(function(group) {
                          var newGroup = {
                            category: group.category,
                            curls: []
                          };

                          for (var j = 0; j < group.curls.length; j++) {
                            if (group.curls[j].name.indexOf(searchTerm) != -1) {
                              newGroup.curls.push(group.curls[j]);
                            }
                          };

                          if (newGroup.curls.length > 0) {
                            //return false;
                            filtered.push(newGroup);
                          }

                          //return true;
                        //});
                        }
                        console.log(filtered)

                        r.set('filtered', filtered)
                    })
                }
              });
              cb();
          });
        };

        fetch("/api/get", "#ui-json", "#tpl-json", function() {
            var btns = document.querySelectorAll('.btn');
            for (var i = 0; i < btns.length; i++) {
                btns[i].addEventListener('mouseleave', function(e) {
                    e.currentTarget.setAttribute('class', 'btn btn-primary-outline');
                    e.currentTarget.removeAttribute('aria-label');
                });
            }
            document.getElementById("searchTerm").focus();
        });
    </script>
    
  </body>
</html>
